<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Астана — Средняя цена (Декабрь 2025)</title>

  <!-- Plotly CDN -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    :root {
      --bg:#000;
      --fg:#fff;
      --muted:rgba(255,255,255,0.70);
      --stroke:rgba(255,255,255,0.14);
      --card:rgba(255,255,255,0.06);
      --orange:#FF9F0A;
      --lin:#B0B0B0;
      --poly:#7A7A7A;
      --trend:#00C2FF;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:18px 18px 26px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:12px;}
    .title{font-size:18px;font-weight:700;letter-spacing:.2px;text-align:center;flex:1;}
    .badge{font-size:12px;color:var(--muted);padding:7px 10px;border:1px solid var(--stroke);border-radius:999px;background:transparent;white-space:nowrap;}
    .grid{display:grid;grid-template-columns:1.65fr 1fr;gap:14px;align-items:start;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}.title{text-align:left;}.top{flex-wrap:wrap;}}
    .chartBox{height:620px;border-radius:18px;overflow:hidden;border:1px solid var(--stroke);background:#000;position:relative;}
    #plot{width:100%;height:100%;}
    .panel{border:1px solid var(--stroke);border-radius:18px;background:var(--card);padding:14px;}
    .panel h3{margin:0 0 10px;font-size:14px;color:var(--muted);font-weight:700;letter-spacing:.2px;}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
    .buttons{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px;}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px;}
    input,button{
      width:100%;
      background:rgba(0,0,0,0.65);
      border:1px solid var(--stroke);
      color:var(--fg);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
    }
    button{cursor:pointer;font-weight:700;border-radius:12px;}
    button.primary{background:rgba(255,255,255,0.10);}
    button.danger{background:rgba(255,80,80,0.10);}
    .hint{margin-top:10px;font-size:12px;color:var(--muted);line-height:1.35;}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <span class="badge">Точки: 01–13 дек</span>
      <div class="title">Средняя цена квартир в Астане в сегменте до 100М тг</div>
      <span class="badge mono">DEC 2025</span>
    </div>

    <div class="grid">
      <div class="chartBox"><div id="plot"></div></div>

      <div class="panel">
        <h3>Добавление данных</h3>

        <div class="row">
          <div>
            <label>Дата</label>
            <input id="d" type="date" />
          </div>
          <div>
            <label>Средняя цена, ₸</label>
            <input id="v" type="number" step="1" placeholder="Напр. 38100000" />
          </div>
        </div>

        <div class="buttons">
          <button class="primary" id="addOne">Добавить точку</button>
          <button id="undo">Удалить последнюю</button>
          <button class="danger" id="reset">Сбросить добавленные</button>
          <button class="primary" id="newTrend">Новый тренд</button>
        </div>

        <div class="hint">
          Hover: значения показываются для добавленных квадратиков и для линии <b>Новый тренд</b>.<br/>
          Ось Y фиксирована: <span class="mono">37 000 000 → 39 000 000</span>, шаг <span class="mono">500 000</span>.
        </div>
      </div>
    </div>
  </div>

<script>
  // --- DATA ---
  const BASE = [{"date": "2025-12-01", "value": 37541293.725366704}, {"date": "2025-12-02", "value": 37716641.35945946}, {"date": "2025-12-03", "value": 37650157.057002455}, {"date": "2025-12-04", "value": 37646021.6379225}, {"date": "2025-12-05", "value": 37715748.896129675}, {"date": "2025-12-06", "value": 37769370.82810811}, {"date": "2025-12-07", "value": 37747161.34109817}, {"date": "2025-12-08", "value": 37728148.321061}, {"date": "2025-12-09", "value": 37761766.91752144}, {"date": "2025-12-10", "value": 37735027.70300118}, {"date": "2025-12-11", "value": 37746386.16229439}, {"date": "2025-12-12", "value": 37757679.78416716}, {"date": "2025-12-13", "value": 37825749.81000943}];
  let added = [];
  let stack = [];
  let trend = null; // {a,b} for y=a+b*x over all points

  const startDate = "2025-12-01";
  const endDate   = "2025-12-31";
  const anchorDate = "2025-12-25";

  const Y_MIN  = 37000000;
  const Y_MAX  = 39000000;
  const Y_STEP = 500000;


  // Y-axis tick labels in millions (e.g., 39.0, 38.5)
  const yTickVals = [];
  const yTickText = [];
  for (let y = Y_MIN; y <= Y_MAX + 1e-9; y += Y_STEP) {
    yTickVals.push(y);
    yTickText.push((y/1000000).toFixed(1));
  }

  const ORANGE = getComputedStyle(document.documentElement).getPropertyValue('--orange').trim();
  const LIN    = getComputedStyle(document.documentElement).getPropertyValue('--lin').trim();
  const POLY   = getComputedStyle(document.documentElement).getPropertyValue('--poly').trim();
  const TREND  = getComputedStyle(document.documentElement).getPropertyValue('--trend').trim();

  const elD = document.getElementById('d');
  const elV = document.getElementById('v');

  // default date
  (function setDefaultDate() {
    const today = new Date();
    const iso = today.toISOString().slice(0,10);
    elD.min = startDate;
    elD.max = endDate;
    elD.value = (iso >= startDate && iso <= endDate) ? iso : "2025-12-14";
  })();

  function toDayIndex(isoDate) {
    const d0 = new Date(startDate + "T00:00:00");
    const d1 = new Date(isoDate + "T00:00:00");
    return (d1 - d0) / (1000*60*60*24);
  }

  function dateFromDayIndex(x) {
    const d0 = new Date(startDate + "T00:00:00");
    const d = new Date(d0.getTime() + x * 24*3600*1000);
    // keep time to prevent duplicate x when sampling
    return d.toISOString().slice(0,19);
  }

  function fmtInt(x) {
    if (!isFinite(x)) return "—";
    return Math.round(x).toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  function fmtM(y) {
    if (!isFinite(y)) return "—";
    const m = y / 1000000;
    const s = m.toFixed(1).replace(/\.0$/, "");
    return `${s}М тг`;
  }

  function uniqueByDate(rows) {
    const m = new Map();
    for (const r of rows) m.set(r.date, Number(r.value));
    return Array.from(m.entries()).sort((a,b)=>a[0].localeCompare(b[0]))
      .map(([date,value]) => ({date, value}));
  }

  function allData() {
    return uniqueByDate(BASE.concat(added));
  }

  // --- Regression ---
  function fitLin(rows) {
    const xs=[], ys=[];
    for (const r of rows) {
      const x = toDayIndex(r.date);
      const y = Number(r.value);
      if (isFinite(x) && isFinite(y)) { xs.push(x); ys.push(y); }
    }
    const n = xs.length;
    if (n < 2) return null;
    let sx=0, sy=0, sxx=0, sxy=0;
    for (let i=0;i<n;i++) {
      const x=xs[i], y=ys[i];
      sx+=x; sy+=y; sxx+=x*x; sxy+=x*y;
    }
    const denom = (n*sxx - sx*sx);
    if (Math.abs(denom) < 1e-12) return null;
    const b = (n*sxy - sx*sy)/denom;
    const a = (sy - b*sx)/n;
    return {a,b};
  }

  function fitPoly2(rows) {
    const xs=[], ys=[];
    for (const r of rows) {
      const x = toDayIndex(r.date);
      const y = Number(r.value);
      if (isFinite(x) && isFinite(y)) { xs.push(x); ys.push(y); }
    }
    const n = xs.length;
    if (n < 3) return null;
    let sx=0, sx2=0, sx3=0, sx4=0, sy=0, sxy=0, sx2y=0;
    for (let i=0;i<n;i++) {
      const x=xs[i], y=ys[i];
      const x2=x*x;
      sx+=x; sx2+=x2; sx3+=x2*x; sx4+=x2*x2;
      sy+=y; sxy+=x*y; sx2y+=x2*y;
    }
    const A = [
      [n,  sx,  sx2, sy],
      [sx, sx2, sx3, sxy],
      [sx2,sx3, sx4, sx2y]
    ];
    for (let col=0; col<3; col++) {
      let piv=col;
      for (let r=col+1; r<3; r++) if (Math.abs(A[r][col]) > Math.abs(A[piv][col])) piv=r;
      if (Math.abs(A[piv][col]) < 1e-12) return null;
      if (piv !== col) { const tmp=A[col]; A[col]=A[piv]; A[piv]=tmp; }
      const div=A[col][col];
      for (let c=col; c<4; c++) A[col][c]/=div;
      for (let r=0; r<3; r++) {
        if (r===col) continue;
        const f=A[r][col];
        for (let c=col; c<4; c++) A[r][c]-=f*A[col][c];
      }
    }
    return {a:A[0][3], b:A[1][3], c:A[2][3]};
  }

  function predLin(f, x) { return f.a + f.b*x; }
  function predP2(f, x)  { return f.a + f.b*x + f.c*x*x; }

  // --- Axis ticks ---
  const tickVals = [];
  const tickText = [];
  for (let d=0; d<=30; d+=3) {
    tickVals.push("2025-12-" + String(1+d).padStart(2,"0"));
    tickText.push(String(1+d).padStart(2,"0") + " дек");
  }

  // --- Plot ---
  function buildTraces() {
    const base = uniqueByDate(BASE);
    const lin = fitLin(base);
    const p2  = fitPoly2(base);

    const traces = [];

    // base points
    traces.push({
      x: base.map(r=>r.date),
      y: base.map(r=>r.value),
      type: "scatter",
      mode: "markers",
      marker: {color: ORANGE, size: 9},
      hovertemplate: "<b>%{x}</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
      customdata: base.map(r => fmtM(r.value))
    });

    // base linear line (dense sampling; straight)
    if (lin) {
      const xs = [], ys = [];
      for (let x=0; x<=30; x+=0.05) {
        xs.push(dateFromDayIndex(x));
        ys.push(predLin(lin, x));
      }
      traces.push({
        x: xs, y: ys,
        type:"scatter",
        mode:"lines",
        line: {color: LIN, width: 2, shape:"linear"},
        hovertemplate: "<b>%{x}</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: ys.map(v => fmtM(v))
      });
    }

    // base poly2 line (dense sampling; straight segments but smooth visually due to density)
    if (p2) {
      const xs = [], ys = [];
      for (let x=0; x<=30; x+=0.05) {
        xs.push(dateFromDayIndex(x));
        ys.push(predP2(p2, x));
      }
      traces.push({
        x: xs, y: ys,
        type:"scatter",
        mode:"lines",
        line: {color: POLY, width: 2, shape:"linear"},
        hovertemplate: "<b>%{x}</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: ys.map(v => fmtM(v))
      });
    }

    // added points (hollow squares; blue outline; hover shows value)
    if (added.length) {
      const a = uniqueByDate(added);
      const ax = a.map(r=>r.date);
      const ay = a.map(r=>r.value);
      traces.push({
        x: ax, y: ay,
        type:"scatter",
        mode:"markers",
        marker: {
          symbol: "square-open",
          size: 11,
          color: TREND,
          line: {color: TREND, width: 2.5}
        },
        hovertemplate: "<b>%{x}</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: ay.map(v => fmtM(v))
      });
    }

    // new trend line (linear over all points) to 31 Dec
    if (trend) {
      const xs = [], ys = [];
      for (let x=0; x<=30; x+=0.05) {
        xs.push(dateFromDayIndex(x));
        ys.push(predLin(trend, x));
      }
      traces.push({
        x: xs, y: ys,
        type:"scatter",
        mode:"lines",
        line: {color: TREND, width: 3, shape:"linear"},
        hovertemplate: "<b>%{x}</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: ys.map(v => fmtM(v))
      });

      // star on 25 Dec for trend (label below via annotation)
      const x25 = toDayIndex(anchorDate);
      const y25 = predLin(trend, x25);
      traces.push({
        x:[anchorDate], y:[y25],
        type:"scatter", mode:"markers",
        marker: {symbol:"star", size: 13, color: TREND, line:{color:"#000", width:1}},
        hovertemplate: "<b>25 дек</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: [fmtM(y25)],
        showlegend:false
      });
    }

    // base stars (white) on 25 Dec for lin & poly
    const ann = [];
    const x25 = toDayIndex(anchorDate);
    if (lin) {
      const yL = predLin(lin, x25);
      traces.push({
        x:[anchorDate], y:[yL],
        type:"scatter", mode:"markers",
        marker: {symbol:"star", size: 13, color:"#fff", line:{color:"#000", width:1}},
        hovertemplate: "<b>25 дек</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: [fmtM(yL)],
        showlegend:false
      });
      ann.push({
        x: anchorDate, y: yL,
        text: fmtM(yL),
        showarrow:false,
        font: {color:"rgba(255,255,255,0.9)", size:12},
        xanchor:"center", yanchor:"bottom",
        yshift: 10
      });
    }
    if (p2) {
      const yP = predP2(p2, x25);
      traces.push({
        x:[anchorDate], y:[yP],
        type:"scatter", mode:"markers",
        marker: {symbol:"star", size: 13, color:"#fff", line:{color:"#000", width:1}},
        hovertemplate: "<b>25 дек</b><br>%{y:,.0f} ₸<br><span style='color:rgba(255,255,255,0.7)'>%{customdata}</span><extra></extra>",
        customdata: [fmtM(yP)],
        showlegend:false
      });
      ann.push({
        x: anchorDate, y: yP,
        text: fmtM(yP),
        showarrow:false,
        font: {color:"rgba(255,255,255,0.9)", size:12},
        xanchor:"center", yanchor:"top",
        yshift: -10
      });
    }

    // label for trend star (below) if exists
    if (trend) {
      const yT = predLin(trend, x25);
      ann.push({
        x: anchorDate, y: yT,
        text: fmtM(yT),
        showarrow:false,
        font: {color:"rgba(255,255,255,0.9)", size:12},
        xanchor:"center", yanchor:"top",
        yshift: -10
      });
    }

    return {traces, annotations: ann};
  }

  function buildLayout(annotations) {
    return {
      paper_bgcolor: "#000",
      plot_bgcolor: "#000",
      margin: {l: 110, r: 20, t: 20, b: 70},
      showlegend: false,
      hovermode: "closest",
      xaxis: {
        type: "date",
        range: [startDate, endDate],
        tickmode: "array",
        tickvals: tickVals,
        ticktext: tickText,
        showgrid: true,
        gridcolor: "rgba(255,255,255,0.14)",
        zeroline: false,
        color: "rgba(255,255,255,0.85)",
        title: {text: "Дата"}
      },
      yaxis: {
        range: [Y_MIN, Y_MAX],
        dtick: Y_STEP,        showgrid: true,
        gridcolor: "rgba(255,255,255,0.14)",
        zeroline: false,
        color: "rgba(255,255,255,0.85)",
        title: {text: "Средняя цена сделки, ₸", standoff: 20}
      },
      annotations
    };
  }

  function redraw() {
    const built = buildTraces();
    const layout = buildLayout(built.annotations);
    const config = {
      responsive: true,
      displayModeBar: true,
      displaylogo: false,
      toImageButtonOptions: {
        format: "png",
        filename: "astana-dec-chart",
        height: 720,
        width: 1280,
        scale: 2
      }
    };
    Plotly.react("plot", built.traces, layout, config);
  }

  // --- Actions ---
  function addPoint(d, v) {
    if (!d || !isFinite(v)) return;
    if (d < startDate || d > endDate) return;
    stack.push(JSON.parse(JSON.stringify(added)));
    added.push({date:d, value:Number(v)});
    added = uniqueByDate(added);
    redraw();
  }

  document.getElementById('addOne').addEventListener('click', () => {
    addPoint(elD.value, Number(elV.value));
  });

  document.getElementById('undo').addEventListener('click', () => {
    if (!stack.length) return;
    added = stack.pop();
    redraw();
  });

  document.getElementById('reset').addEventListener('click', () => {
    stack.push(JSON.parse(JSON.stringify(added)));
    added = [];
    trend = null;
    redraw();
  });

  document.getElementById('newTrend').addEventListener('click', () => {
    trend = fitLin(allData());
    redraw();
  });

  // initial draw
  redraw();
</script>
</body>
</html>
